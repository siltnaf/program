C51 COMPILER V9.54   MAIN                                                                  04/18/2021 17:49:32 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN Main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Main.c OMF2 ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE DEBUG TABS(2)

line level    source

   1          
   2          #include "STC15F104E.h"
   3          
   4           
   5          #include "./public/inc/config.h" 
   6          #include "./public/inc/delay.h"  
   7          #include "./public/inc/init.h"
   8          #include "./public/inc/process.h"
   9          
  10          volatile uint8 state,next_state,switch_state;
  11          volatile uint8   LED_type;
  12          volatile uint16 process_time,buz_time,key_holdtime;
  13          volatile uint16 Time_us, Time_ms,Time_sec,Time_min,power_refresh,PWM_low,PWM_high,PWM;
  14          volatile bit Timer_update,UV_on,switch_update,refresh;
  15          
  16          
  17          void Enable_power()
  18          {
  19   1        
  20   1      
  21   1      if (((power_refresh%20)==0)&&((Time_ms<500)==0)) 
  22   1      {
  23   2        
  24   2        VCC_EN=0;
  25   2      } else VCC_EN=1;
  26   1           
  27   1       
  28   1        
  29   1      }
  30          
  31          
  32          
  33          void Check_switch()
  34          {
  35   1           
  36   1      
  37   1        if (key_holdtime>press_200ms) 
  38   1          {
  39   2              if ((key_holdtime>press_3s)&&(SW==1))
  40   2              {
  41   3                state=standby_mode;
  42   3                switch_state=0;
  43   3                key_holdtime=0;
  44   3                switch_update=0;
  45   3              }
  46   2              else if ((key_holdtime<press_3s)&&(SW==0))
  47   2              {
  48   3              switch_state++;
  49   3              if (switch_state>4) switch_state=0;
  50   3              
  51   3        
  52   3             
  53   3        
  54   3            switch (switch_state)
  55   3            {
C51 COMPILER V9.54   MAIN                                                                  04/18/2021 17:49:32 PAGE 2   

  56   4              case 0:     
  57   4                
  58   4                          LED_type=0;
  59   4                          AUXR &= ~(1<<4);    //stop timer2 counter PWM
  60   4                          PWM_FAN=0;
  61   4                          state=standby_mode;
  62   4                          break;
  63   4      
  64   4              case 1:     power_refresh=0;
  65   4                          LED_type=4;
  66   4                          if (USB_det==0)
  67   4                              {
  68   5                                PWM = 3000 ;    // 50% duty
  69   5                                LoadPWM(PWM);
  70   5                                SET_CMOS(IO_TURBO);
  71   5                                TURBO=1;
  72   5                              }
  73   4                            else 
  74   4                              {
  75   5                                PWM=2000;
  76   5                                LoadPWM(PWM);
  77   5                                SET_CMOS(IO_TURBO);
  78   5                                TURBO=0;
  79   5                              }
  80   4              
  81   4                          state=quite_mode;
  82   4                          break;
  83   4              
  84   4              case 2:     
  85   4                          power_refresh=0;
  86   4                          LED_type=1;
  87   4                          if (USB_det==0)
  88   4                            {
  89   5                              PWM = 5000 ;    // 50% duty
  90   5                              LoadPWM(PWM);
  91   5                              SET_CMOS(IO_TURBO);
  92   5                              TURBO=1;
  93   5                            }
  94   4                            else
  95   4                            {
  96   5                              PWM = 4000 ;    // 50% duty
  97   5                              LoadPWM(PWM);
  98   5                              SET_CMOS(IO_TURBO);
  99   5                              TURBO=0;
 100   5                              
 101   5                            }
 102   4                          state=speed0_mode;
 103   4                          break;
 104   4              case 3:     
 105   4                          power_refresh=0;
 106   4                          LED_type=2;
 107   4              
 108   4                           
 109   4                          AUXR &= ~(1<<4);    //stop counter
 110   4                          PWM_FAN=1;  
 111   4                          SET_INPUT(IO_TURBO);
 112   4                           
 113   4                          state=speed1_mode;
 114   4                          break;
 115   4              
 116   4              case 4:     
 117   4                          power_refresh=0;
C51 COMPILER V9.54   MAIN                                                                  04/18/2021 17:49:32 PAGE 3   

 118   4                          LED_type=3;
 119   4                          AUXR &= ~(1<<4);    //stop counter
 120   4                          PWM_FAN=1;  
 121   4                          SET_CMOS(IO_TURBO);
 122   4                          TURBO=0;
 123   4                          
 124   4                          state=speed2_mode;
 125   4                          break;
 126   4              
 127   4            
 128   4            
 129   4              
 130   4            } 
 131   3            
 132   3        
 133   3            Time_ms=0;
 134   3            Time_sec=0;
 135   3            Time_min=0;
 136   3            switch_update=0;
 137   3            key_holdtime=0;
 138   3            delay_ms(250);
 139   3          }   
 140   2        
 141   2         
 142   2          
 143   2        }
 144   1      
 145   1        
 146   1      }
 147                
 148              
 149              
 150              
 151            
 152            
 153            
 154          
 155          void State_process()
 156          {
 157   1          switch (state)
 158   1          {
 159   2        
 160   2        case standby_mode:    
 161   2                          LED_type=0;
 162   2                         
 163   2                          switch_state=0;
 164   2                          AUXR &= ~(1<<4);    //stop timer2 counter PWM
 165   2                          PWM_FAN=0;
 166   2                          next_state=standby_mode;
 167   2                          break;
 168   2        
 169   2        
 170   2        case quite_mode:
 171   2                          Enable_power();
 172   2        
 173   2                          if (USB_det==1)
 174   2                            {
 175   3                                PWM=2000;
 176   3                                LoadPWM(PWM);
 177   3                                SET_CMOS(IO_TURBO);
 178   3                                TURBO=0;
 179   3                            }
C51 COMPILER V9.54   MAIN                                                                  04/18/2021 17:49:32 PAGE 4   

 180   2              
 181   2                          
 182   2                          AUXR |=  (1<<4);    //start timer2
 183   2        
 184   2        
 185   2                          next_state=quite_mode;
 186   2                          break;
 187   2        
 188   2        
 189   2        case speed0_mode:       
 190   2                          
 191   2                          Enable_power();
 192   2                          if (USB_det==1)
 193   2                          {
 194   3                            
 195   3                              PWM = 4000 ;    // 50% duty
 196   3                              LoadPWM(PWM);
 197   3                              SET_CMOS(IO_TURBO);
 198   3                              TURBO=0;
 199   3                              
 200   3                            
 201   3                          }
 202   2              
 203   2                          
 204   2        
 205   2                          AUXR |=  (1<<4);    //start timer2
 206   2                          next_state=speed0_mode;
 207   2                          break;
 208   2        
 209   2        case speed1_mode:       
 210   2                          
 211   2                          Enable_power();
 212   2                         
 213   2                        
 214   2                        
 215   2                          next_state=speed1_mode;
 216   2                          break;
 217   2        
 218   2        case speed2_mode:     
 219   2                          Enable_power();
 220   2                         
 221   2      
 222   2                         
 223   2                          
 224   2                         next_state=speed2_mode;
 225   2                          break;
 226   2        
 227   2        
 228   2        
 229   2      
 230   2      
 231   2      
 232   2        
 233   2          }
 234   1          
 235   1      state=next_state;
 236   1      
 237   1      
 238   1      }
 239          
 240          
 241          
C51 COMPILER V9.54   MAIN                                                                  04/18/2021 17:49:32 PAGE 5   

 242          
 243          
 244          
 245          
 246          
 247          void main(void) 
 248          {
 249   1        IO_Init();
 250   1        InitTime0();
 251   1        InitTime2();
 252   1        InitExtInterrupt();
 253   1      
 254   1        InitParameter() ;
 255   1      
 256   1        
 257   1        
 258   1        
 259   1        while(1) 
 260   1        { 
 261   2        
 262   2      
 263   2         
 264   2          
 265   2          Check_switch();
 266   2          State_process();
 267   2          
 268   2      
 269   2          Process_Timer();
 270   2       
 271   2          Process_LED();
 272   2         
 273   2        
 274   2          Process_sleep();
 275   2      
 276   2      
 277   2          
 278   2        } 
 279   1      }
 280          
 281          void int0() interrupt 0
 282          {
 283   1      
 284   1         if ((switch_update==0)&&(SW==1)) 
 285   1         {
 286   2            Time_us=0;
 287   2            Time_ms=0;
 288   2            Time_sec=0;
 289   2            Time_min=0;
 290   2            
 291   2            key_holdtime=0;
 292   2            switch_update=1;
 293   2         }
 294   1      }
 295          
 296          void int1() interrupt 2
 297          {
 298   1         
 299   1      }
 300          
 301          
 302           
 303          void timer0() interrupt 1
C51 COMPILER V9.54   MAIN                                                                  04/18/2021 17:49:32 PAGE 6   

 304          {
 305   1      
 306   1      if (switch_update==1) 
 307   1      {
 308   2        key_holdtime++;
 309   2        
 310   2        
 311   2        
 312   2          
 313   2          }
 314   1         
 315   1        Timer_update=1;
 316   1      }
 317          
 318          
 319          
 320          
 321          void timer2() interrupt 12  
 322          {
 323   1        PWM_FAN =~PWM_FAN;
 324   1       if(PWM_FAN==1)
 325   1          {
 326   2              
 327   2              T2H = (PWM_low >> 8);   //LED on time is 10% 
 328   2              T2L =  PWM_low;
 329   2          }
 330   1          else
 331   1          {
 332   2            
 333   2              T2H = (PWM_high >> 8);  //LED off time is 90%
 334   2              T2L = PWM_high;
 335   2          }
 336   1           
 337   1      }
 338          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    669    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     26    ----
   BIT SIZE         =      4    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
