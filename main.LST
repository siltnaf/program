C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN Main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Main.c OMF2 ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE DEBUG TABS(2)

line level    source

   1          
   2          #include "STC15F104E.h"
   3          
   4           
   5          #include "./public/inc/config.h" 
   6          #include "./public/inc/delay.h"  
   7          #include "./public/inc/init.h"
   8          #include "./public/inc/process.h"
   9          
  10          volatile uint8 state,next_state,switch_state;
  11          volatile uint8   LED_type;
  12          volatile uint16 process_time,buz_time,key_holdtime;
  13          volatile uint16 Time_us, Time_ms,Time_sec,Time_min,power_refresh,PWM_low,PWM_high,PWM;
  14          volatile bit Timer_update,UV_on,switch_update,refresh,USB_check,USB_prev;
  15          
  16          
  17          void Enable_power()
  18          {
  19   1        
  20   1      
  21   1      if (((power_refresh%20)==0)&&((Time_ms<500)==0)) 
  22   1      {
  23   2        
  24   2        VCC_EN=0;
  25   2      } else VCC_EN=1;
  26   1           
  27   1       
  28   1        
  29   1      }
  30          
  31          
  32          
  33          void Check_switch()
  34          {
  35   1           
  36   1      
  37   1        if (key_holdtime>press_200ms) 
  38   1          {
  39   2              if ((key_holdtime>press_3s)&&(SW==1))
  40   2              {
  41   3                state=standby_mode;
  42   3                switch_state=0;
  43   3                key_holdtime=0;
  44   3                switch_update=0;
  45   3              }
  46   2              else if ((key_holdtime<press_3s)&&(SW==0))
  47   2              {
  48   3              switch_state++;
  49   3              if (switch_state>4) switch_state=0;
  50   3              
  51   3        
  52   3             
  53   3        
  54   3            switch (switch_state)
  55   3            {
C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 2   

  56   4              case 0:     
  57   4                
  58   4                          LED_type=0;
  59   4                          AUXR &= ~(1<<4);    //stop timer2 counter PWM
  60   4                          PWM_FAN=0;
  61   4                          state=standby_mode;
  62   4                          break;
  63   4      
  64   4              case 1:     power_refresh=0;
  65   4                          LED_type=4;
  66   4                          USB_check=1;    
  67   4              
  68   4              
  69   4              
  70   4                          state=quite_mode;
  71   4                          break;
  72   4              
  73   4              case 2:     
  74   4                          power_refresh=0;
  75   4                          LED_type=1;
  76   4                          USB_check=1;    
  77   4              
  78   4                          state=speed0_mode;
  79   4                          break;
  80   4              case 3:     
  81   4                          power_refresh=0;
  82   4                          LED_type=2;
  83   4              
  84   4                           
  85   4                          AUXR &= ~(1<<4);    //stop counter
  86   4                          PWM_FAN=1;  
  87   4                          SET_INPUT(IO_TURBO);
  88   4                           
  89   4                          state=speed1_mode;
  90   4                          break;
  91   4              
  92   4              case 4:     
  93   4                          power_refresh=0;
  94   4                          LED_type=3;
  95   4                          AUXR &= ~(1<<4);    //stop counter
  96   4                          PWM_FAN=1;  
  97   4                          SET_CMOS(IO_TURBO);
  98   4                          TURBO=0;
  99   4                          
 100   4                          state=speed2_mode;
 101   4                          break;
 102   4              
 103   4            
 104   4            
 105   4              
 106   4            } 
 107   3            
 108   3        
 109   3            Time_ms=0;
 110   3            Time_sec=0;
 111   3            Time_min=0;
 112   3            switch_update=0;
 113   3            key_holdtime=0;
 114   3            delay_ms(250);
 115   3          }   
 116   2        
 117   2         
C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 3   

 118   2          
 119   2        }
 120   1      
 121   1        
 122   1      }
 123                
 124              
 125              
 126              
 127            
 128            
 129            
 130          
 131          void State_process()
 132          {
 133   1          switch (state)
 134   1          {
 135   2        
 136   2        case standby_mode:    
 137   2                          LED_type=0;
 138   2                         
 139   2                          switch_state=0;
 140   2                          AUXR &= ~(1<<4);    //stop timer2 counter PWM
 141   2                          PWM_FAN=0;
 142   2                          next_state=standby_mode;
 143   2                          break;
 144   2        
 145   2        
 146   2        case quite_mode:
 147   2                          Enable_power();
 148   2        
 149   2                          if ((USB_det!=USB_prev)&&(USB_check==0))
 150   2                          {
 151   3                            USB_check=1;
 152   3                            USB_prev=USB_det;
 153   3                          }
 154   2                            
 155   2                          if (USB_check==1)
 156   2                          {
 157   3                            USB_check=0;
 158   3                          
 159   3                            if (USB_det==1)
 160   3                            {
 161   4                              PWM=2500;
 162   4                              LoadPWM(PWM);
 163   4                              SET_CMOS(IO_TURBO);
 164   4                              TURBO=0;
 165   4                            }
 166   3                            else
 167   3                            {
 168   4                              PWM=3750;
 169   4                              LoadPWM(PWM);
 170   4                              SET_CMOS(IO_TURBO);
 171   4                              TURBO=1;
 172   4                            }
 173   3                          }
 174   2                            
 175   2                
 176   2                              
 177   2              
 178   2                          
 179   2                          AUXR |=  (1<<4);    //start timer2
C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 4   

 180   2        
 181   2        
 182   2                          next_state=quite_mode;
 183   2                          break;
 184   2        
 185   2        
 186   2        case speed0_mode:       
 187   2                          
 188   2                          Enable_power();
 189   2        
 190   2                          if ((USB_det!=USB_prev)&&(USB_check==0))
 191   2                          {
 192   3                            USB_check=1;
 193   3                            USB_prev=USB_det;
 194   3                          }
 195   2                            
 196   2                          if (USB_check==1)
 197   2                          {
 198   3                            USB_check=0;
 199   3                          
 200   3                            if (USB_det==1)
 201   3                            {
 202   4                              PWM=3600;
 203   4                              LoadPWM(PWM);
 204   4                              SET_CMOS(IO_TURBO);
 205   4                              TURBO=0;
 206   4                              AUXR |=  (1<<4);    //start timer2
 207   4                            }
 208   3                            else
 209   3                            {
 210   4                              AUXR &= ~(1<<4);    //stop counter
 211   4                              PWM_FAN=1;  
 212   4                              SET_CMOS(IO_TURBO);
 213   4                              TURBO=1;
 214   4                            }
 215   3                          }
 216   2                          
 217   2        
 218   2                      
 219   2                          next_state=speed0_mode;
 220   2                          break;
 221   2        
 222   2        case speed1_mode:       
 223   2                          
 224   2                          Enable_power();
 225   2                         
 226   2                        
 227   2                        
 228   2                          next_state=speed1_mode;
 229   2                          break;
 230   2        
 231   2        case speed2_mode:     
 232   2                          Enable_power();
 233   2                         
 234   2      
 235   2                         
 236   2                          
 237   2                         next_state=speed2_mode;
 238   2                          break;
 239   2        
 240   2        
 241   2        
C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 5   

 242   2      
 243   2      
 244   2      
 245   2        
 246   2          }
 247   1          
 248   1      state=next_state;
 249   1      
 250   1      
 251   1      }
 252          
 253          
 254          
 255          
 256          
 257          
 258          
 259          
 260          void main(void) 
 261          {
 262   1        IO_Init();
 263   1        InitTime0();
 264   1        InitTime2();
 265   1        InitExtInterrupt();
 266   1      
 267   1        InitParameter() ;
 268   1      
 269   1        
 270   1        
 271   1        
 272   1        while(1) 
 273   1        { 
 274   2        
 275   2      
 276   2         
 277   2          
 278   2          Check_switch();
 279   2          State_process();
 280   2          
 281   2      
 282   2          Process_Timer();
 283   2       
 284   2          Process_LED();
 285   2         
 286   2        
 287   2          Process_sleep();
 288   2      
 289   2      
 290   2          
 291   2        } 
 292   1      }
 293          
 294          void int0() interrupt 0
 295          {
 296   1      
 297   1         if ((switch_update==0)&&(SW==1)) 
 298   1         {
 299   2            Time_us=0;
 300   2            Time_ms=0;
 301   2            Time_sec=0;
 302   2            Time_min=0;
 303   2            
C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 6   

 304   2            key_holdtime=0;
 305   2            switch_update=1;
 306   2         }
 307   1      }
 308          
 309          void int1() interrupt 2
 310          {
 311   1         
 312   1      }
 313          
 314          
 315           
 316          void timer0() interrupt 1
 317          {
 318   1      
 319   1      if (switch_update==1) 
 320   1      {
 321   2        key_holdtime++;
 322   2        
 323   2        
 324   2        
 325   2          
 326   2          }
 327   1         
 328   1        Timer_update=1;
 329   1      }
 330          
 331          
 332          
 333          
 334          void timer2() interrupt 12  
 335          {
 336   1        PWM_FAN =~PWM_FAN;
 337   1       if(PWM_FAN==1)
 338   1          {
 339   2              
 340   2              T2H = (PWM_low >> 8);   //LED on time is 10% 
 341   2              T2L =  PWM_low;
 342   2          }
 343   1          else
 344   1          {
 345   2            
 346   2              T2H = (PWM_high >> 8);  //LED off time is 90%
 347   2              T2L = PWM_high;
 348   2          }
 349   1           
 350   1      }
 351          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    654    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     26    ----
   BIT SIZE         =      6    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
C51 COMPILER V9.54   MAIN                                                                  05/09/2021 06:06:13 PAGE 7   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
