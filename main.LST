C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN Main.OBJ
COMPILER INVOKED BY: c:\Keil_v5\C51\BIN\C51.EXE Main.c OMF2 ROM(COMPACT) OPTIMIZE(8,SPEED) BROWSE DEBUG TABS(2)

line level    source

   1          
   2          #include "STC15F104E.h"
   3          
   4           
   5          #include "./public/inc/config.h" 
   6          #include "./public/inc/delay.h"  
   7          #include "./public/inc/init.h"
   8          #include "./public/inc/process.h"
   9          
  10          volatile uint8 state,next_state,SW1_state,next_SW1_state;
  11          volatile uint8   O3_level,LED_type;
  12          volatile uint16 process_time,buz_time,key_holdtime;
  13          volatile uint16 Time_us, Time_ms,Time_sec,Time_min,scan_sec;
  14          volatile bit Timer_update,Beep, UV_on,ION_on,O3_on,switch_update,SW1_pressed,SW2_pressed,scan;
  15          
  16          
  17          
  18          void DCDC_enable(void)
  19          {
  20   1      
  21   1        
  22   1        
  23   1        
  24   1                              //P35 as input
  25   1          
  26   1                            P3M1 |=0x20;                        // P3M1 |= 0b00100000;
  27   1                            P3M0 &=0xdf;                        // P3M0 &= 0b11011111;          
  28   1      
  29   1      //
  30   1        if ((VCC_det==0)&&((Time_ms<500)==0)) VCC_EN=0; else VCC_EN=1;
  31   1        
  32   1      }
  33          
  34          
  35          
  36          
  37            
  38          void Check_switch()
  39          {
  40   1          if (key_holdtime>press_200ms) 
  41   1          {
  42   2            
  43   2            switch (SW1_state)
  44   2              
  45   2            {
  46   3              case 0:   LED_type=0;
  47   3                          break;
  48   3              case 1:   LED_type=1;
  49   3                          break;
  50   3              case 2:   LED_type=2;
  51   3                        break;
  52   3              case 3:  
  53   3                        
  54   3              
  55   3              
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 2   

  56   3              
  57   3      
  58   3              
  59   3              
  60   3              
  61   3              
  62   3              
  63   3              
  64   3              
  65   3              
  66   3              
  67   3              
  68   3              
  69   3              
  70   3              
  71   3              
  72   3            
  73   3            
  74   3            if ((key_holdtime>press_3s)&&(SW1==1))
  75   3              {
  76   4                state=standby_mode;
  77   4                SW1_state=0;
  78   4                key_holdtime=0;
  79   4                SW1_pressed=0;
  80   4                switch_update=0;
  81   4              
  82   4              }
  83   3              else if ((key_holdtime<press_3s)&&(SW1==0))
  84   3              {
  85   4          
  86   4                SW1_state++;
  87   4              if (SW1_state>3) SW1_state=0;
  88   4            
  89   4                switch (SW1_state)
  90   4                {
  91   5                case 0:     
  92   5                        
  93   5                          state=standby_mode;
  94   5                          break;
  95   5                case 1:     
  96   5                          
  97   5                          state=ION_mode;
  98   5                          break;
  99   5                case 2:     
 100   5                        
 101   5                        
 102   5                          state=O3_mode;
 103   5                          break;
 104   5                case 3:     
 105   5                        
 106   5                        
 107   5                          state=UVION_mode;
 108   5                          break;
 109   5              
 110   5              
 111   5                } 
 112   4           
 113   4                
 114   4                
 115   4              
 116   4                key_holdtime=0;
 117   4                SW1_pressed=0;
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 3   

 118   4                switch_update=0;
 119   4                delay_ms(250);
 120   4              }
 121   3          }   
 122   2        
 123   2         
 124   2          
 125   2      
 126   2      
 127   2        
 128   2      
 129   2      //  
 130   2      //   if ((Time_ms%100)<10)
 131   2      //   {
 132   2      //     SW2=0;
 133   2      //     SET_INPUT(IO_SW2);
 134   2      //     if ((Time_ms%100)>5) 
 135   2      //     {
 136   2      //       EX1=1;
 137   2      //       EX0=1;
 138   2      //     }
 139   2      //   }
 140   2      //   else 
 141   2      //   {
 142   2      //     EX1=0;
 143   2      //     EX0=0;
 144   2      //     SET_CMOS(IO_SW2);
 145   2      //     if (O3_on==1) SW2=1; else SW2=0;
 146   2      //   }
 147   2      //     
 148   2          
 149   2      
 150   2      
 151   2        
 152   2      }
 153   1            
 154   1          
 155   1          
 156   1          
 157   1        
 158   1        
 159   1        
 160   1      
 161   1      void State_process()
*** ERROR C141 IN LINE 161 OF Main.c: syntax error near 'void'
 162   1      {
 163   2          switch (state)
 164   2          {
 165   3        
 166   3        case standby_mode:    
 167   3                          
 168   3                          VCC_EN=1;
 169   3                          ION_on=0;
 170   3                          O3_level  = 0;
 171   3                          UV_on  = 0;
 172   3                          next_SW1_state=1;
 173   3                          LED_type=0;
 174   3                          next_state=standby_mode;
 175   3        
 176   3                         
 177   3        
 178   3                          break;
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 4   

 179   3        
 180   3        case ION_mode:        
 181   3                          
 182   3                        DCDC_enable();
 183   3                            
 184   3                         LED_type=1;
 185   3                         O3_level=0;
 186   3                          UV_on=0;
 187   3                          ION_on=1;
 188   3                          next_state=ION_mode;
 189   3                         
 190   3                      
 191   3                          break;
 192   3        
 193   3        case O3_mode:       
 194   3                          
 195   3                          DCDC_enable();  
 196   3                          LED_type=2;
 197   3                          O3_level=2;
 198   3                          UV_on=0;
 199   3                          ION_on=0;
 200   3                          if (Time_min>=59) 
 201   3                          {
 202   4                            
 203   4                            next_state=O3_saving_mode; 
 204   4                          }else next_state=O3_mode;
 205   3                           
 206   3                          break;
 207   3          
 208   3          case O3_saving_mode:
 209   3                          
 210   3                          DCDC_enable();
 211   3                          LED_type=4;
 212   3          
 213   3                          
 214   3                          UV_on=0;
 215   3                          ION_on=0;
 216   3                          if (Time_min<=5) 
 217   3                          {
 218   4                              O3_level=2;
 219   4                          }else   O3_level=0;
 220   3                            
 221   3          
 222   3          
 223   3                          next_state=O3_saving_mode;
 224   3                         
 225   3                          break;
 226   3                          
 227   3          
 228   3        
 229   3        case UVION_mode:      
 230   3                          
 231   3                        DCDC_enable();
 232   3        
 233   3                         LED_type=1;
 234   3                          O3_level=2;
 235   3                          UV_on=1;
 236   3                          ION_on=0;
 237   3                          
 238   3                          if (Time_min>=time_T1) next_state=ozone_mode; else next_state=UVION_mode;
 239   3        
 240   3                
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 5   

 241   3                         
 242   3                          break;
 243   3        
 244   3        
 245   3        case ozone_mode:  
 246   3                            
 247   3                        DCDC_enable();
 248   3                        LED_type=3;
 249   3                          O3_level=2;
 250   3                          UV_on=0;
 251   3                          ION_on=0;
 252   3                          
 253   3        
 254   3         
 255   3                          if (Time_min>=time_T2) next_state=wait_mode; else   next_state=ozone_mode;
 256   3                            
 257   3                       
 258   3                          break;
 259   3            
 260   3      
 261   3      
 262   3        case wait_mode: 
 263   3                            
 264   3                        DCDC_enable();
 265   3                          LED_type=3;
 266   3                          O3_level=0;
 267   3                          UV_on=0;
 268   3                          ION_on=1;
 269   3                          
 270   3        
 271   3        
 272   3                 
 273   3                          if (Time_min>=time_T3) 
 274   3                          {
 275   4                            
 276   4                            
 277   4                            buz_time=0;
 278   4                            Time_ms=0;
 279   4                            Time_sec=0;
 280   4                            next_state=BUZ_mode; 
 281   4                          }
 282   3                            else  next_state=wait_mode;
 283   3                         
 284   3                          
 285   3                          break;
 286   3      
 287   3                          
 288   3        case BUZ_mode:
 289   3                        
 290   3                          Beep=1;
 291   3                          delay_ms(250);
 292   3                          Beep=0;
 293   3                          delay_ms(250);
 294   3                          Beep=1;
 295   3                          delay_ms(250);
 296   3                          Beep=0;
 297   3                          BUZ=0;
 298   3                          delay_ms(500);
 299   3                          LED_type=0;
 300   3                          next_state=  standby_mode;
 301   3                         
 302   3                          break;
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 6   

 303   3        
 304   3          }
 305   2          
 306   2      state=next_state;
 307   2      
 308   2      
 309   2      }
 310   1      
 311   1      
 312   1      
 313   1      
 314   1      
 315   1      
 316   1      
 317   1      
 318   1      void main(void) 
 319   1      {
 320   1        IO_Init();
 321   1        InitTime0();
 322   1        InitTime2();
 323   1        InitExtInterrupt();
 324   1      
 325   1        InitParameter() ;
 326   1      
 327   1        while(1) 
 328   1        { 
 329   2        
 330   2      
 331   2          
 332   2          Check_switch();
 333   2          State_process();
 334   2          
 335   2      
 336   2          Process_Timer();
 337   2          Process_ION();
 338   2          Process_UV();
 339   2          Process_LED();
 340   2          Process_BUZ();
 341   2          Process_O3();
 342   2          Process_sleep();
 343   2      
 344   2      
 345   2          
 346   2        } 
 347   1      }
 348          
 349          void int0() interrupt 0
 350          {
 351   1      
 352   1         if ((switch_update==0)&&(SW1==1)) 
 353   1         {
 354   2            Time_us=0;
 355   2            Time_ms=0;
 356   2            Time_sec=0;
 357   2            Time_min=0;
 358   2            SW1_pressed=1;
 359   2            key_holdtime=0;
 360   2             
 361   2            switch_update=1;
 362   2         }
 363   1      }
 364          
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 7   

 365          void int1() interrupt 2
 366          {
 367   1      
 368   1          if ((switch_update==0)&&(SW2==1)) 
 369   1         {
 370   2           
 371   2            Time_us=0;
 372   2            Time_ms=0;
 373   2            Time_sec=0;
 374   2            Time_min=0;
 375   2            SW2_pressed=1;
 376   2            key_holdtime=0;
 377   2             
 378   2            switch_update=1;
 379   2         }
 380   1      }
 381          
 382          
 383           
 384          void timer0() interrupt 1
 385          {
 386   1      
 387   1      if (switch_update==1) 
 388   1      {
 389   2        key_holdtime++;
 390   2       
 391   2        
 392   2        
 393   2          
 394   2          }
 395   1         
 396   1        Timer_update=1;
 397   1      }
 398          
 399          
 400          
 401          
 402          void timer2() interrupt 12  
 403          {
 404   1       if (Beep==1) 
 405   1          {
 406   2          
 407   2          //P32 as output
 408   2        //                      P3M1   P3M0
 409   2        //P30(BUZ)->INPUT         1      1
 410   2        //P31(LED)->CMOS          0      1
 411   2        //P32(SW1/BUZ)->INPUT       0      1
 412   2        //P33(O3)->OUTPUT         0      0
 413   2        //P34(UV)->CMOS           0      1
 414   2        //P35(ION)->OUTPUT        0      0
 415   2              
 416   2      
 417   2        //P3M1 &=0b1111 1011;
 418   2        //P3M0 |=0b0000 0100;
 419   2        
 420   2        
 421   2          P3M1 &= 0xfb;               //P32 as CMOS output  
 422   2          P3M0 |= 0x04;
 423   2            
 424   2          BUZ=~BUZ;
 425   2      }
 426   1          else BUZ=0;
C51 COMPILER V9.54   MAIN                                                                  09/01/2020 17:40:16 PAGE 8   

 427   1      }
 428          

C51 COMPILATION COMPLETE.  0 WARNING(S),  1 ERROR(S)
